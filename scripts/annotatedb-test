#! /usr/bin/env nix-shell
#! nix-shell -i bash -p annotatedb cabal2db jq

function fail() {
  echo "FAIL: $1" >> /dev/stderr
  exit 1
}

DUMP=$(dump-hackage list-extras) ||
    fail "Couldn't dump list-extras (cabal2db problem?)"

ANN=$(echo "$DUMP" | annotateDb list-extras) ||
    fail "Couldn't annotate list-extras '$DUMP'"

LEN=$(echo "$ANN" | jq 'length') ||
    fail "Couldn't get length of annotated list-extras '$ANN'"

[[ "$LEN" -gt 0 ]] || fail "Got no annotated ASTs '$LEN'"

for FIELD in package module name dependencies type arity
do
    LENFIELD=$(echo "$ANN" | jq "map(.$FIELD) | length") ||
        fail "Couldn't get number of annotated ASTs with '$FIELD' field"
    [[ "$LEN" -eq "$LENFIELD" ]] ||
        fail "Number of ASTs is '$LEN' but number with field '$FIELD' is '$LENFIELD'"
done
